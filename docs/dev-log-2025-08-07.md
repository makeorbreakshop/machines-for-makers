# Development Log - August 7, 2025

## Today's Work Summary

### 1. ComMarker B6 30W Price Extraction Failure
- **Issue**: Batch update showed 164/167 successful extractions (98.2% success rate)
- **Failures**: ComMarker B6 30W, ComMarker B6 MOPA 60W, Thunder Nova 24
- **Root Cause**: ComMarker machines failed due to incorrect price extraction from static header
- **Challenge**: Page shows different prices based on wattage selection (20W vs 30W)

### 2. WooCommerce Dynamic Pricing Investigation
- **Discovery**: ComMarker uses WooCommerce variations with dynamic pricing
- **Problem**: Header price ($1,839) is static and shows 20W price
- **Solution Needed**: Must select 30W variant to see correct price ($2,399) in bundle section
- **Test Scripts Created**: 
  - `test_commarker_b6.py` - Initial debugging
  - `test_commarker_debug.py` - HTML structure analysis
  - `extract_variations.py` - WooCommerce data parser
  - `test_commarker_production.py` - Production workflow test

### 3. Site-Specific Extraction Rules Update
- **Updated**: `/scrapers/site_specific_extractors.py` for ComMarker B6 30W
- **Configuration**:
  ```python
  'ComMarker B6 30W': {
      'requires_dynamic': True,  # MUST select 30W variant first
      'variant_selection': {
          'wattage_selector': 'input[value="30W"]',
          'wait_for_update': '.wd-swatch-tooltip .price',
      },
      'price_selectors': [
          '.wd-swatch-tooltip:has(.wd-swatch-text:contains("B6 Basic Bundle")) .price ins bdi',
      ],
      'avoid_selectors': [
          '.entry-summary > .price',  # AVOID header price (static 20W price)
      ],
      'price_validation': {
          'min': 2300,
          'max': 2500
      }
  }
  ```

### 4. Production Testing Results
- **Scrapfly Behavior**: Successfully fetches page but extracts wrong prices
- **Extracted Values**: $55 and $5,555 (both failed validation)
- **Root Issue**: Scrapfly gets static content without performing variant selection
- **Current State**: Needs Scrapfly enhancement to handle dynamic interactions

### 5. SOLUTION IMPLEMENTED - ComMarker B6 30W Fixed!
- **Root Cause Identified**: 
  - Learned selector `.woocommerce-Price-amount` was extracting $55 from shipping/accessory elements
  - Common selector `.price` was extracting "$55 $55" which parsed as $5555
  - The correct sale price $2,399 was in `<ins>` tags but not being prioritized
- **Fix Applied**:
  1. **Blacklisted generic selector**: Added `.woocommerce-Price-amount` to blacklist for commarker.com
  2. **Updated price selectors**: Prioritized sale price selectors targeting `<ins>` tags:
     ```python
     '.price ins .woocommerce-Price-amount bdi',
     'ins .woocommerce-Price-amount bdi', 
     '.price ins .amount bdi'
     ```
  3. **Cleared learned selector**: Removed cached selector from database
- **Result**: Successfully extracts $2,399 using selector `.price ins .woocommerce-Price-amount bdi`
- **Validation**: Price now matches historical baseline, no more validation failures

## Status Summary

### What's Working:
- ✅ ComMarker B6 30W now extracts correct sale price ($2,399)
- ✅ Sale price prioritization working for WooCommerce sites
- ✅ Historical price matching selects correct price from multiple options
- ✅ Blacklist prevents bad learned selectors from being used

### What's Not Working:
- Scrapfly doesn't perform required variant selection (clicking 30W) - but not needed with sale price extraction
- CSS `:has()` selector with `:contains()` triggers deprecation warning (minor issue)

### Technical Notes:
- WooCommerce stores sale prices in `<ins>` tags within price structure
- Regular prices are in `<del>` tags when items are on sale
- Multiple price elements exist on page (bundles, accessories, savings amounts)
- Historical price matching helps select correct price from multiple valid options

### Lessons Learned:
1. **Generic selectors are dangerous** on complex e-commerce sites
2. **Sale prices need special handling** - always check for `<ins>` tags
3. **Learned selectors can become stale** when sites update their structure
4. **Blacklisting bad selectors** is essential for sites with complex pricing