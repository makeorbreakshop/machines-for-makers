# Development Log - August 8, 2025

## Today's Work Summary

### 1. Price Tracker Cron Job Performance Investigation
- **Issue**: Cron job taking 9291 seconds (2.5 hours) vs manual admin button taking 931 seconds (15.5 minutes) for similar batch operations
- **Discovery**: Both processes update approximately 160-168 machines with same Python service
- **User Concern**: Need reliable weekend execution when not at computer

### 2. Root Cause Analysis - System Sleep State at 3 AM
- **Investigation**: Compared batch logs from both runs:
  - Cron job: `batch_20250808_030642_3daf3bce.log` (3:06:42 AM to 5:41:33 AM)
  - Manual run: `batch_20250807_073146_8df9d786.log` (7:31:46 AM to 7:47:17 AM)
- **Key Finding**: Cron job had 5 Puppeteer timeouts (30 seconds each) while manual run had 0 timeouts
- **Root Cause**: Mac system in low-power state at 3 AM causing browser automation timeouts

### 3. Discovered Local Launchd Configuration (Not Vercel!)
- **Initial Confusion**: Saw `vercel.json` with cron configuration, assumed Vercel deployment
- **Reality Check**: User clarified "THIS ISNT ON VERCEL DAMMIT!" - it's local macOS launchd
- **Configuration Location**: `~/Library/LaunchAgents/com.machinesformakers.pricetracker.plist`
- **Script Location**: `/price-extractor-python/cron_runner.sh`

### 4. Multiple Issues Identified in Cron Setup
- **Issue 1**: System sleep causing Puppeteer timeouts at 3 AM
- **Issue 2**: Outdated parameters in `cron_runner.sh`:
  - Using old `batch_size: 20` parameter instead of `max_workers`
  - Missing `use_scrapfly: true` parameter
  - Only 5 workers configured vs 8 workers in manual runs
- **Issue 3**: Cron script directly calling Python API instead of using Next.js endpoint

### 5. Implemented Caffeinate Solution
- **Solution**: Modified launchd plist to wrap command with `caffeinate -dis`
  ```xml
  <array>
      <string>/usr/bin/caffeinate</string>
      <string>-dis</string>
      <string>/Users/brandoncullum/machines-for-makers/price-extractor-python/cron_runner.sh</string>
  </array>
  ```
- **Flags Explained**:
  - `-d`: Prevent display sleep
  - `-i`: Prevent idle sleep
  - `-s`: Prevent system sleep

### 6. Updated Cron Runner Script Parameters
- **Fixed Parameters**: Updated to match manual run configuration:
  ```bash
  curl -X POST http://localhost:8000/api/v1/batch-update \
    -H "Content-Type: application/json" \
    -d '{"days_threshold": 0, "max_workers": 8, "use_scrapfly": true}' \
    -s
  ```
- **Benefits**: 
  - 8 concurrent workers instead of 5
  - Explicit Scrapfly pipeline usage
  - Consistent with manual admin runs

### 7. Reloaded Launchd Configuration
- **Applied Changes**: `launchctl unload` and `launchctl load` to activate new configuration
- **Expected Results**: Next 3 AM run should complete in 15-20 minutes instead of 2.5 hours

## Technical Notes

### Performance Difference Breakdown:
1. **Puppeteer Timeouts**: 5 × 30 seconds = 150 seconds of timeouts in cron job
2. **Worker Count**: 5 workers (cron) vs 8 workers (manual) = 37.5% less concurrency
3. **System State**: Low-power state affects Chrome/Puppeteer performance significantly

### Launchd vs Cron:
- macOS uses launchd instead of traditional cron
- Configuration via XML plist files
- Supports wake-from-sleep scheduling
- Can wrap commands with system utilities like caffeinate

### Caffeinate Utility:
- macOS built-in tool to prevent system sleep
- Ensures full system performance during batch operations
- Perfect for long-running scheduled tasks

## Status Summary

### What's Working:
- ✅ Identified root cause of 10x performance difference
- ✅ Fixed system sleep issues with caffeinate
- ✅ Updated parameters to match optimal configuration
- ✅ Maintained local execution as required for weekend runs

### What's Not Working:
- Still using separate cron_runner.sh instead of unified Next.js endpoint
- Hardcoded 45-minute wait in script (could be optimized)

### Lessons Learned:
1. **System sleep states** significantly impact browser automation performance
2. **Parameter consistency** between manual and automated runs is critical
3. **Local scheduled tasks** on macOS should use caffeinate for reliability
4. **Always verify deployment assumptions** - local != cloud

### Next Steps:
1. Monitor next 3 AM run to verify performance improvement
2. Consider updating cron_runner.sh to poll for completion instead of fixed wait
3. Potentially unify to use Next.js cron endpoint for consistency