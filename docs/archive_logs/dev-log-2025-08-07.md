# Development Log - August 7, 2025

## Today's Work Summary

### 1. ComMarker B6 30W Price Extraction Failure
- **Issue**: Batch update showed 164/167 successful extractions (98.2% success rate)
- **Failures**: ComMarker B6 30W, ComMarker B6 MOPA 60W, Thunder Nova 24
- **Root Cause**: ComMarker machines failed due to incorrect price extraction from static header
- **Challenge**: Page shows different prices based on wattage selection (20W vs 30W)

### 2. WooCommerce Dynamic Pricing Investigation
- **Discovery**: ComMarker uses WooCommerce variations with dynamic pricing
- **Problem**: Header price ($1,839) is static and shows 20W price
- **Solution Needed**: Must select 30W variant to see correct price ($2,399) in bundle section
- **Test Scripts Created**: 
  - `test_commarker_b6.py` - Initial debugging
  - `test_commarker_debug.py` - HTML structure analysis
  - `extract_variations.py` - WooCommerce data parser
  - `test_commarker_production.py` - Production workflow test

### 3. Site-Specific Extraction Rules Update
- **Updated**: `/scrapers/site_specific_extractors.py` for ComMarker B6 30W
- **Configuration**:
  ```python
  'ComMarker B6 30W': {
      'requires_dynamic': True,  # MUST select 30W variant first
      'variant_selection': {
          'wattage_selector': 'input[value="30W"]',
          'wait_for_update': '.wd-swatch-tooltip .price',
      },
      'price_selectors': [
          '.wd-swatch-tooltip:has(.wd-swatch-text:contains("B6 Basic Bundle")) .price ins bdi',
      ],
      'avoid_selectors': [
          '.entry-summary > .price',  # AVOID header price (static 20W price)
      ],
      'price_validation': {
          'min': 2300,
          'max': 2500
      }
  }
  ```

### 4. Production Testing Results
- **Scrapfly Behavior**: Successfully fetches page but extracts wrong prices
- **Extracted Values**: $55 and $5,555 (both failed validation)
- **Root Issue**: Scrapfly gets static content without performing variant selection
- **Current State**: Needs Scrapfly enhancement to handle dynamic interactions

### 5. SOLUTION IMPLEMENTED - ComMarker B6 30W Fixed!
- **Root Cause Identified**: 
  - Learned selector `.woocommerce-Price-amount` was extracting $55 from shipping/accessory elements
  - Common selector `.price` was extracting "$55 $55" which parsed as $5555
  - The correct sale price $2,399 was in `<ins>` tags but not being prioritized
- **Fix Applied**:
  1. **Blacklisted generic selector**: Added `.woocommerce-Price-amount` to blacklist for commarker.com
  2. **Updated price selectors**: Prioritized sale price selectors targeting `<ins>` tags:
     ```python
     '.price ins .woocommerce-Price-amount bdi',
     'ins .woocommerce-Price-amount bdi', 
     '.price ins .amount bdi'
     ```
  3. **Cleared learned selector**: Removed cached selector from database
- **Result**: Successfully extracts $2,399 using selector `.price ins .woocommerce-Price-amount bdi`
- **Validation**: Price now matches historical baseline, no more validation failures

## Status Summary

### What's Working:
- âœ… ComMarker B6 30W now extracts correct sale price ($2,399)
- âœ… Sale price prioritization working for WooCommerce sites
- âœ… Historical price matching selects correct price from multiple options
- âœ… Blacklist prevents bad learned selectors from being used

### What's Not Working:
- Scrapfly doesn't perform required variant selection (clicking 30W) - but not needed with sale price extraction
- CSS `:has()` selector with `:contains()` triggers deprecation warning (minor issue)

### Technical Notes:
- WooCommerce stores sale prices in `<ins>` tags within price structure
- Regular prices are in `<del>` tags when items are on sale
- Multiple price elements exist on page (bundles, accessories, savings amounts)
- Historical price matching helps select correct price from multiple valid options

### Lessons Learned:
1. **Generic selectors are dangerous** on complex e-commerce sites
2. **Sale prices need special handling** - always check for `<ins>` tags
3. **Learned selectors can become stale** when sites update their structure
4. **Blacklisting bad selectors** is essential for sites with complex pricing

## Price Alerts Email System Implementation

### 6. Lead Magnet Strategy Session
- **Goal**: Convert price tracking system into email list builder
- **Decision**: Implement simple weekly deal digest (vs complex per-machine alerts)
- **Approach**: Single URL `/deals-alerts` where everyone gets same weekly email
- **Target**: Drive purchases through urgency (deals going away)

### 7. Email System Architecture Built
- **Landing Page**: Created `/deals-alerts` with compelling copy and social proof
- **API Integration**: Built `/api/convertkit/deal-alerts` endpoint with automatic tagging
- **Database**: Created `email_subscribers` table with RLS policies:
  ```sql
  CREATE TABLE email_subscribers (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    convertkit_subscriber_id TEXT,
    tags TEXT[] DEFAULT '{}',
    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'unsubscribed', 'bounced')),
    source TEXT,
    referrer TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    unsubscribed_at TIMESTAMP WITH TIME ZONE
  );
  ```

### 8. Admin Email Generator
- **Location**: `/admin/email-generator` added to admin sidebar
- **Features**:
  - Date range and minimum discount filters
  - Automatic subject line generation based on top deal
  - Responsive HTML email template with:
    - Hero deal section (biggest discount)
    - Stats bar (total deals, savings, avg discount)
    - Grid of additional deals
    - All-time low badges
    - Direct links to product pages
  - Copy to clipboard functionality
  - Live preview pane

### 9. ConvertKit (Kit) Setup
- **Form Created**: "Deal Alerts" form with ID stored in `CONVERTKIT_DEAL_ALERTS_FORM_ID`
- **Tag System**: Auto-tags subscribers with "deal-alerts" for segmentation
- **Double Opt-in**: Configured confirmation email with redirect to `/deals` page
- **Integration**: Form submission automatically adds tag via API

### 10. Success Message Updates
- **Before**: Generic "You're on the list!" with green checkmark
- **After**: "Check your email!" with blue mail icon
- **Enhancement**: Shows actual email address and explains confirmation process
- **UX**: Clear expectations about Tuesday 10am ET delivery schedule

### Implementation Status:
- âœ… Landing page live and capturing emails
- âœ… ConvertKit integration working with auto-tagging
- âœ… Email generator creating beautiful HTML emails
- âœ… Manual process ready for weekly sends
- ðŸ”„ Future: Automation with cron jobs and Kit API

### Next Steps:
1. Send first test email to validate flow
2. Add `/deals-alerts` link to navigation and marketing materials
3. Begin weekly email routine (generate Monday, send Tuesday)
4. Track metrics: signups, opens, clicks, conversions

## Price Tracker Email Integration Enhancement

### 11. Integrated Email Generation into Price Tracker
- **Issue**: Admin had separate email generator page but needed integration with price tracker for better workflow
- **Solution**: Added Email Generation Mode toggle directly in Price Tracker admin page
- **Implementation**:
  - Toggle switch enables email-specific filters and deal selection
  - Separate checkboxes for email selection vs bulk operations
  - Filters: price drops only, minimum discount, date range, all-time lows
  - Auto-selects top 10 deals when entering email mode
  - Generate Email button creates HTML and switches to Email Template tab

### 12. Email Deal Fetching Fix
- **Bug**: Email mode showed "0 deals match filters" despite having deals in database
- **Root Cause**: 
  1. `useEffect` dependency array missing `emailGenerationMode`
  2. Missing fields in `fetchEmailDeals` (laserPower, productUrl)
- **Fix Applied**:
  ```typescript
  // Added emailGenerationMode to dependency array
  useEffect(() => {
    if (emailGenerationMode) {
      const refetchDeals = async () => {
        setLoadingEmailDeals(true);
        const deals = await fetchEmailDeals();
        setEmailDeals(deals);
        setLoadingEmailDeals(false);
      };
      refetchDeals();
    }
  }, [emailGenerationMode, priceDropsOnly, minDiscountThreshold, dateRangeFilter, allTimeLowsOnly]);
  ```

### 13. Email Generation Improvements
- **Enhanced UX**:
  - Success toast notification when email is generated
  - Auto-switch to Email Template tab (with fallback logic)
  - Fixed long decimal percentages (5.107% â†’ 5%)
  - Warning message if deals found but none selected
  - Debug console logging for troubleshooting
- **Email Stats**: Shows total deals, total savings, average discount, all-time lows
- **HTML Template**: Responsive design with hero deal, stats bar, and additional deals grid

### Implementation Complete:
- âœ… Email generation fully integrated into Price Tracker workflow
- âœ… Database-level filtering for ALL matching deals (not just recent 50)
- âœ… Auto-selection of top deals for better UX
- âœ… Clean percentage formatting in emails
- âœ… Email HTML ready to copy to ConvertKit/Kit